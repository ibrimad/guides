LINUX SECURITY
==============

http://plusbryan.com/my-first-5-minutes-on-a-server-or-essential-security-for-linux-servers

## Debian/Ubuntu

```bash
apt-get update
apt-get upgrade
apt-get install fail2ban
```

Add hosts to hosts.allow to prevent accidentally locking yourself out.
Typically, add at least your home or office IP addresses.

```bash
# example hosts.allow
ALL: 1.2.3.4
ALL: 10.10.10.0/24
```


## Configure fail2ban

```bash
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
vim /etc/fail2ban/jail.local
```

** Useful Filters **
* http://serverfault.com/questions/420895/how-to-use-fail2ban-for-nginx


## Setup sudo

```bash
apt-get install sudo
visudo
```

```bash
# sudoers
root    ALL=(ALL) ALL
%admin  ALL=(ALL) ALL
```

## Add users to admin group to allow them to sudo

```bash
addgroup admin
usermod -a -G admin <user>
```


## Lockdown SSH

First add your keyless ssh by running the following command from your local machine
(or wherever you have SSH keys already setup).

[Create a strong](http://martin.kleppmann.com/2013/05/24/improving-security-of-ssh-private-keys.html) ssh key.

```bash
# on machine you're going to ssh from
ssh-copy-id -i ~/.ssh/id_rsa.pub <server ip>
```

Now test to make sure passwordless ssh works

```bash
ssh <server ip>
```

**DO NOT PROCEED** if you're prompted for a password by the server.
This means passwordless ssh was not setup properly.

If everything worked out, edit sshd_config on the server to lockdown ssh.

```bash
vim /etc/ssh/sshd_config
```

Disable root and password authentications.

```bash
# /etc/ssh/sshd_config
PermitRootLogin no
PasswordAuthentication no
```

Restart sshd

```bash
service ssh restart
```


Setup Firewall

```bash
apt-get install ufw
ufw default deny incoming
ufw default allow outgoing
# allow all private network traffic
# customize or you will lock yourself out!!!
ufw allow from 10.10.10.0/24
ufw enable
```


Setup unattended apt security upgrades

```bash
apt-get install unattended-upgrades
vim /etc/apt/apt.conf.d/10periodic
```

The 10periodic file will not exist. Make it look like ...

```bash
# /etc/apt/apt.conf.d/10periodic
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Download-Upgradeable-Packages "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
```

Edit 50unattended-upgrades to only auto install security updates by commenting out everything else.

```bash
vim /etc/apt/apt.conf.d/50unattended-upgrades
```

```bash
# /etc/apt/apt.conf.d/50unattended-upgrades
Unattended-Upgrade::Allowed-Origins {
  // "${distro_id} stable";
  "${distro_id} ${distro_codename}-security";
};
```


Setup LogWatch

```bash
apt-get install logwatch
vim /etc/cron.daily/00logwatch
```

Add this line

```
/usr/sbin/logwatch --output mail --mailto test@example.com --detail high
```


# Setup SE Linux

### References

* http://wiki.debian.org/SELinux/Setup
* https://fedoraproject.org/wiki/SELinux

### Setup for Ubuntu

```bash
apt-get install selinux
# Not sure what else is required?
```

### Setup for Debian

```bash
apt-get install selinux-basics selinux-policy-default auditd
selinux-activate

# If hosting on DigitalOcean setup kexec to boot with the correct kernel options
# http://www.youtube.com/watch?v=LHNPTvMwHPE
apt-get install kexec-tools
vim /etc/init.d/rcS
# Should look like...
if grep -qv ' kexeced$' /proc/cmdline ;then
  # Make sure the --append section includes the existing /proc/cmdline options plus selinux
  kexec --load /vmlinuz --initrd=/initrd.img --append=' root=LABEL=DOROOT ro selinux=1 security=selinux kexeced' &&
  mount -o ro,remount / &&
  kexec -e
fi
exec /etc/init.d/rc S

# Set FSCKFIX to true
vim /etc/default/rcS
set FSCKFIX=yes

# Reboot and check if everything is working
reboot
check-selinux-installation
sestatus

# Ignore /etc/pam.d/login errors reported on Debian wheezy

# See Package Specific fixes for additional security steps
# http://wiki.debian.org/SELinux/Setup
# e.g. removing shadow and gshadow from /etc/cron.daily/passwd

# See all SELinux denied requests
audit2why -al

# If fail2ban is denied access to gam_server change fail2ban backend to polling
vim /etc/fail2ban/jail.local
# backend = polling

# If using custom ssh port, add port to selinux
semanage port -a -t ssh_port_t -p tcp 1234

# List programs protected by SELinux policy
seinfo -t | grep exec_t

# List security context for a file, user, or process
ls -Z file.foo
id -Z
ps -eZ

# Generate a policy template that allows all denied requests since last reboot
# http://docs.fedoraproject.org/en-US/Fedora/13/html/SELinux_FAQ/index.html#id3343680
cd /etc/selinux
audit2allow -m local -l -i /var/log/audit/audit.log > local.te
checkmodule -M -m -o local.mod local.te
semodule_package -o local.pp -m local.mod
semodule -i local.pp

# Example local.te generated by audit2allow
# !!! Use at your own risk !!!
# These policies should not be considered secure.
# It's a good idea after package updates to disable policies in local.te by commenting
# them out and recompiling the policy file. Package maintainers periodically fix either
# the package (e.g. exim) or the package's selinux policy file making local policy
# adjustments obsolete.
module local 1.0;
require {
	type iptables_t;
	type sysctl_crypto_t;
	type exim_t;
	type proc_t;
	class dir search;
	class file { read getattr open };
	class filesystem getattr;
}
#============= exim_t ==============
allow exim_t sysctl_crypto_t:dir search;
allow exim_t sysctl_crypto_t:file { read getattr open };
#============= iptables_t ==============
allow iptables_t proc_t:filesystem getattr;


# To restart a service use run_init
# See http://www.crypt.gen.nz/selinux/faq.html
run_init /etc/init.d/sshd restart
```




# Harden Linux

See http://www.debian.org/doc/manuals/securing-debian-howto/ch-automatic-harden.en.html

```bash
apt-get install harden-tools harden-environment harden-servers harden-clients
```




WEB SERVER SECURITY
===================

http://simonholywell.com/post/2013/04/three-things-i-set-on-new-servers.html

